<!DOCTYPE html>
<html>
<head>
    <title>DBT Column Lineage</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/graph.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/explore.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/impact.css') }}">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            {% if explore_mode %}
            <div class="explore-panel">
                <h3>Explore Lineage</h3>
                <div class="search-bar-container">
                    <input type="text" id="modelSearchInput" placeholder="Search models...">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <div id="model-tree-container">
                </div>
                <div class="explore-panel-actions">
                    <div class="column-selector">
                        <label for="columnSelect">Column:</label>
                        <div class="custom-select disabled" id="columnSelectWrapper">
                            <div class="custom-select-trigger" id="columnSelectTrigger">
                                <span class="custom-select-value"><span class="option-text">Select a model first</span></span>
                                <svg class="custom-select-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                            <div class="custom-select-options" id="columnSelectOptions">
                                <div class="column-search-container">
                                    <input type="text" id="columnSearchInput" class="column-search-input" placeholder="Search columns..." autocomplete="off">
                                    <svg class="column-search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                </div>
                                <div class="custom-select-options-list" id="columnSelectOptionsList">
                                    <div class="custom-select-option" data-value=""><span class="option-text">Select a column</span></div>
                                </div>
                            </div>
                        </div>
                        <select id="columnSelect" disabled style="display: none;">
                            <option value="">Select a model first</option>
                        </select>
                    </div>
                    <div class="action-buttons">
                        <button id="loadLineage" disabled>Load Lineage</button>
                    </div>
                </div>
            </div>
            {% endif %}
            <!-- Impact Analysis Panel -->
            <div id="impactAnalysisPanel" class="impact-panel" style="display: none;">
                <div class="impact-panel-resize-handle" id="impactPanelResizeHandle"></div>
                <div class="impact-panel-header">
                    <div class="header-content">
                        <h3>Impact Analysis</h3>
                        <p class="header-subtitle">What happens if I change this column?</p>
                    </div>
                    <button id="closeImpactPanel" class="close-button">×</button>
                </div>
                <div id="impactAnalysisContent" class="impact-panel-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="controls">
                <h3>Controls</h3>
                <button id="zoomIn">Zoom In</button>
                <button id="zoomOut">Zoom Out</button>
                <button id="resetView">Reset View</button>
                <button id="relayout">Re-layout</button>
            </div>
        </div>
        <div id="graph">
            <div id="relationshipSummaryCard" class="relationship-summary-card" style="display: none;">
                <div class="relationship-summary-header">
                    <div class="relationship-summary-title">
                        <span class="relationship-summary-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"></path>
                                <circle cx="12" cy="12" r="5"></circle>
                            </svg>
                        </span>
                        <div>
                            <h4>Column Relationship Summary</h4>
                            <p class="relationship-summary-subtitle">Relationship overview for this column</p>
                        </div>
                    </div>
                    <button class="relationship-summary-close" id="closeRelationshipSummaryCard">×</button>
                </div>
                <div class="relationship-summary-content">
                    <div class="relationship-summary-metrics" id="relationshipSummaryMetrics">
                        <!-- Metrics will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div id="impactAnalysisCard" class="impact-analysis-card" style="display: none;">
                <div class="impact-card-header">
                    <div class="impact-card-title">
                        <span class="impact-card-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"></path>
                                <circle cx="12" cy="12" r="5"></circle>
                            </svg>
                        </span>
                        <div>
                            <h4>What happens if I change this column?</h4>
                            <p class="impact-card-subtitle">Understand the impact of modifying this column's logic on downstream models, transformations, and dashboards</p>
                        </div>
                    </div>
                    <button class="impact-card-close" id="closeImpactAnalysisCard">×</button>
                </div>
                <div class="impact-card-content">
                    <div class="impact-card-explanation">
                        <p>
                            <strong>Impact Analysis</strong> shows you what will be affected if you modify this column:
                        </p>
                        <ul>
                            <li>Which <strong>models and columns</strong> depend on this column</li>
                            <li>Which <strong>transformations</strong> (SUM, CASE, etc.) use this column and may need review</li>
                            <li>Which <strong>dashboards and exposures</strong> will be impacted</li>
                        </ul>
                        <p>
                            This helps you understand the <strong>blast radius</strong> of your changes before making them.
                        </p>
                    </div>
                    <button id="loadImpactAnalysisFromCard" class="impact-card-button">
                        Analyze Impact
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="{{ url_for('static', path='/vendor/d3.v7.min.js') }}"></script>
    <script src="https://dagrejs.github.io/project/dagre/latest/dagre.min.js"></script>
    <script src="{{ url_for('static', path='/js/config.js') }}"></script>
    <script src="{{ url_for('static', path='/js/dataProcessor.js') }}"></script>
    <script src="{{ url_for('static', path='/js/utils.js') }}"></script>
    <script src="{{ url_for('static', path='/js/renderer.js') }}"></script>
    <script src="{{ url_for('static', path='/js/interactions.js') }}"></script>
    <script src="{{ url_for('static', path='/js/graph.js') }}"></script>
    <script src="{{ url_for('static', path='/js/explore.js') }}"></script>
    <script src="{{ url_for('static', path='/js/impact.js') }}"></script>
    <script src="{{ url_for('static', path='/js/app.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const initialData = {{ data | tojson }};
            const isExploreMode = {% if explore_mode %}true{% else %}false{% endif %};
            window.app.init(initialData, isExploreMode);
        });
    </script>
</body>
</html>
