<!DOCTYPE html>
<html>
<head>
    <title>DBT Column Lineage</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/styles.css') }}">
    <script src="{{ url_for('static', path='/vendor/d3.v7.min.js') }}"></script>
    <script src="https://dagrejs.github.io/project/dagre/latest/dagre.min.js"></script>
    <script src="{{ url_for('static', path='/js/config.js') }}"></script>
    <script src="{{ url_for('static', path='/js/dataProcessor.js') }}"></script>
    <script src="{{ url_for('static', path='/js/utils.js') }}"></script>
    <script src="{{ url_for('static', path='/js/renderer.js') }}"></script>
    <script src="{{ url_for('static', path='/js/interactions.js') }}"></script>
    <script src="{{ url_for('static', path='/js/graph.js') }}"></script>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            {% if explore_mode %}
            <div class="explore-panel">
                <h3>Explore Lineage</h3>
                <div class="search-bar-container">
                    <input type="text" id="modelSearchInput" placeholder="Search models...">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <div id="model-tree-container">
                </div>
                <div class="explore-panel-actions">
                    <div class="column-selector">
                        <label for="columnSelect">Column:</label>
                        <div class="custom-select disabled" id="columnSelectWrapper">
                            <div class="custom-select-trigger" id="columnSelectTrigger">
                                <span class="custom-select-value"><span class="option-text">Select a model first</span></span>
                                <svg class="custom-select-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                            <div class="custom-select-options" id="columnSelectOptions">
                                <div class="custom-select-option" data-value=""><span class="option-text">Select a column</span></div>
                            </div>
                        </div>
                        <select id="columnSelect" disabled style="display: none;">
                            <option value="">Select a model first</option>
                        </select>
                    </div>
                    <button id="loadLineage" disabled>Load Lineage</button>
                </div>
            </div>
            {% endif %}
            <div class="controls">
                <h3>Controls</h3>
                <button id="zoomIn">Zoom In</button>
                <button id="zoomOut">Zoom Out</button>
                <button id="resetView">Reset View</button>
                <button id="relayout">Re-layout</button>
            </div>
        </div>
        <div id="graph"></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Data:', {{ data | tojson }});
            let graphInstance = initGraph({{ data | tojson }});
            
            {% if explore_mode %}
            const columnSelect = document.getElementById('columnSelect');
            const loadLineageBtn = document.getElementById('loadLineage');
            const graphContainer = document.getElementById('graph');
            const modelTreeContainer = document.getElementById('model-tree-container');
            const searchInput = document.getElementById('modelSearchInput');
            
            let selectedModelData = null;
            let allTreeData = [];
            
            const iconFolderClosed = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon folder-icon closed"><path d="M3 7C3 5.89543 3.89543 5 5 5H9.58579C9.851 5 10.1054 5.10536 10.2929 5.29289L12 7H19C20.1046 7 21 7.89543 21 9V18C21 19.1046 20.1046 20 19 20H5C3.89543 20 3 19.1046 3 18V7Z" fill="currentColor" fill-opacity="0.3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            const iconFolderOpen = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon folder-icon open"><path d="M3 7C3 5.89543 3.89543 5 5 5H9.58579C9.851 5 10.1054 5.10536 10.2929 5.29289L12 7H19C20.1046 7 21 7.89543 21 9V10M3 11L4.5 17.5C4.77614 18.6 5.77614 19.5 6.9 19.5H17.1C18.2239 19.5 19.2239 18.6 19.5 17.5L21 11H3Z" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            const iconModel = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon model-icon"><path d="M12 3L3 7.5V16.5L12 21L21 16.5V7.5L12 3Z" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 12L21 7.5M12 12L3 7.5M12 12V21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            const iconSource = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon source-icon"><path d="M12 5C7 5 4 6.5 4 8.5C4 10.5 7 12 12 12C17 12 20 10.5 20 8.5C20 6.5 17 5 12 5Z" fill="currentColor" fill-opacity="0.3" stroke="currentColor" stroke-width="1.5"/><path d="M4 8.5V15.5C4 17.5 7 19 12 19C17 19 20 17.5 20 15.5V8.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M4 12C4 14 7 15.5 12 15.5C17 15.5 20 14 20 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
            const iconSeed = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon seed-icon"><path d="M3 6C3 4.34315 4.34315 3 6 3H14L18 7V18C18 19.6569 16.6569 21 15 21H6C4.34315 21 3 19.6569 3 18V6Z" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 3V7H18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 12H14M7 16H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
            const iconExposure = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon exposure-icon"><path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2Z" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 2V8H20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
            const iconDefault = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon default-icon"><rect x="4" y="4" width="16" height="16" rx="2" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

            function renderTree(nodes, container, level = 0) {
                const ul = document.createElement('ul');
                ul.classList.add('model-tree');
                if (level > 0) ul.classList.add('nested');

                nodes.forEach(node => {
                    const li = document.createElement('li');
                    const nodeType = node.resource_type === 'exposure' ? 'exposure' : node.type;
                    li.classList.add('tree-node', `tree-node-${nodeType}`);
                    
                    const nodeContent = document.createElement('div');
                    nodeContent.classList.add('node-content');
                    
                    const iconContainer = document.createElement('span');
                    iconContainer.classList.add('icon-container');

                    const span = document.createElement('span');
                    span.textContent = node.type === 'model' ? node.display_name : node.name; 
                    span.classList.add('node-label');

                    if (node.type === 'folder') {
                        nodeContent.classList.add('folder');
                        iconContainer.innerHTML = iconFolderClosed;
                        nodeContent.appendChild(iconContainer);
                        nodeContent.appendChild(span);
                        
                        li.appendChild(nodeContent);

                        nodeContent.addEventListener('click', () => {
                            li.classList.toggle('expanded');
                            const nestedUl = li.querySelector('ul');
                            const icon = iconContainer.querySelector('.folder-icon');
                            if (nestedUl) {
                                nestedUl.classList.toggle('active');
                                if (li.classList.contains('expanded')) {
                                    iconContainer.innerHTML = iconFolderOpen;
                                } else {
                                    iconContainer.innerHTML = iconFolderClosed;
                                }
                            }
                        });
                        if (node.children && node.children.length > 0) {
                             renderTree(node.children, li, level + 1);
                             const childUl = li.querySelector('ul');
                             if(childUl) childUl.classList.remove('active');
                        } else {
                            li.classList.add('empty-folder'); // Style empty folders if needed
                        }
                    } else { // It's a model or exposure node
                        if (node.resource_type === 'exposure') {
                            nodeContent.classList.add('exposure');
                            iconContainer.innerHTML = iconExposure;
                            nodeContent.appendChild(iconContainer);
                            nodeContent.appendChild(span);
                            li.appendChild(nodeContent);
                            
                            // Exposures don't have columns, so clicking them doesn't populate column selector
                            nodeContent.addEventListener('click', () => {
                                document.querySelectorAll('.model-tree .node-content.selected').forEach(el => el.classList.remove('selected'));
                                nodeContent.classList.add('selected');
                                // Don't populate column selector for exposures
                                const columnSelectWrapper = document.getElementById('columnSelectWrapper');
                                const columnSelectValue = document.querySelector('.custom-select-value');
                                const columnSelectOptions = document.getElementById('columnSelectOptions');
                                columnSelect.innerHTML = '<option value="">Exposures don\'t have columns</option>';
                                columnSelectOptions.innerHTML = '<div class="custom-select-option" data-value=""><span class="option-text">Exposures don\'t have columns</span></div>';
                                const resetContent = document.createElement('div');
                                resetContent.className = 'option-content';
                                const resetText = document.createElement('span');
                                resetText.className = 'option-text';
                                resetText.textContent = 'Exposures don\'t have columns';
                                resetContent.appendChild(resetText);
                                columnSelectValue.innerHTML = '';
                                columnSelectValue.appendChild(resetContent);
                                columnSelectWrapper.classList.add('disabled');
                                columnSelect.disabled = true;
                                loadLineageBtn.disabled = true;
                            });
                        } else {
                            nodeContent.classList.add('model');
                            let modelIcon = iconDefault;
                            if (node.resource_type === 'model') modelIcon = iconModel;
                            else if (node.resource_type === 'source') modelIcon = iconSource;
                            else if (node.resource_type === 'seed') modelIcon = iconSeed;
                            
                            iconContainer.innerHTML = modelIcon;
                            nodeContent.appendChild(iconContainer);
                            nodeContent.appendChild(span);

                            li.appendChild(nodeContent);

                            span.dataset.modelName = node.model_name;
                            
                            nodeContent.addEventListener('click', () => {
                                document.querySelectorAll('.model-tree .node-content.selected').forEach(el => el.classList.remove('selected'));
                                nodeContent.classList.add('selected');
                                
                                selectedModelData = node;
                                populateColumnSelector(node.columns);
                                loadLineageBtn.disabled = true;
                            });
                        }
                    }
                    ul.appendChild(li);
                });
                container.appendChild(ul);
            }
            
            function filterTree(searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                const allNodes = modelTreeContainer.querySelectorAll('.tree-node');

                // Reset visibility and expansion
                allNodes.forEach(node => {
                    node.style.display = '';
                    // Collapse all folders initially unless search is empty
                    if (node.classList.contains('tree-node-folder') && term !== '') {
                        node.classList.remove('expanded');
                        const nestedUl = node.querySelector('ul.nested');
                        if (nestedUl) nestedUl.classList.remove('active');
                        const iconContainer = node.querySelector('.icon-container');
                        if(iconContainer) iconContainer.innerHTML = iconFolderClosed;
                    }
                });

                if (term === '') return;

                const modelNodes = modelTreeContainer.querySelectorAll('.tree-node-model, .tree-node-exposure');
                const foldersToShow = new Set();

                modelNodes.forEach(modelLi => {
                    const label = modelLi.querySelector('.node-label');
                    const modelName = label ? label.textContent.toLowerCase() : '';
                    const matches = modelName.includes(term);

                    if (matches) {
                        modelLi.style.display = 'block';
                        let current = modelLi.parentElement;
                        while (current && current !== modelTreeContainer) {
                            if (current.tagName === 'LI' && current.classList.contains('tree-node-folder')) {
                                foldersToShow.add(current);
                            }
                            current = current.parentElement;
                        }
                    } else {
                        modelLi.style.display = 'none';
                    }
                });

                // Show necessary folders and hide others
                const folderNodes = modelTreeContainer.querySelectorAll('.tree-node-folder');
                folderNodes.forEach(folderLi => {
                    if (foldersToShow.has(folderLi)) {
                        folderLi.style.display = 'block';
                        if (!folderLi.classList.contains('expanded')) {
                           folderLi.classList.add('expanded');
                           const nestedUl = folderLi.querySelector('ul.nested');
                           if (nestedUl) nestedUl.classList.add('active');
                           const iconContainer = folderLi.querySelector('.icon-container');
                           if (iconContainer) iconContainer.innerHTML = iconFolderOpen;
                        }
                    } else {
                        folderLi.style.display = 'none';
                    }
                });
            }

            function getTagColor(type) {
                if (!type) return '#cbd5e1';
                const typeStr = type.toLowerCase();
                const defaultColor = '#cbd5e1';
                
                if (typeStr.includes('int') || typeStr.includes('decimal') || 
                    typeStr.includes('numeric') || typeStr.includes('double') || 
                    typeStr.includes('float')) {
                    return '#7cb7fc';
                }
                
                if (typeStr.includes('varchar') || typeStr.includes('char') || 
                    typeStr.includes('text') || typeStr.includes('string')) {
                    return '#4ddba4';
                }
                
                if (typeStr.includes('date') || typeStr.includes('time')) {
                    return '#b29dfc';
                }
                
                if (typeStr.includes('bool')) {
                    return '#f98b8b';
                }
                
                if (typeStr.includes('variant')) {
                    return '#fca154';
                }
                
                return defaultColor;
            }

            function getShortType(type) {
                if (!type) return 'unknown';
                return type.toLowerCase()
                    .replace('character varying', 'varchar')
                    .replace('double precision', 'double')
                    .replace('timestamp without time zone', 'timestamp')
                    .replace('timestamp with time zone', 'timestamptz');
            }

            function populateColumnSelector(columns) {
                const columnSelectWrapper = document.getElementById('columnSelectWrapper');
                const columnSelectTrigger = document.getElementById('columnSelectTrigger');
                const columnSelectOptions = document.getElementById('columnSelectOptions');
                const columnSelectValue = columnSelectTrigger.querySelector('.custom-select-value');
                
                // Update hidden select for form compatibility
                columnSelect.innerHTML = '<option value="">Select a column</option>';
                
                // Update custom dropdown
                columnSelectOptions.innerHTML = '<div class="custom-select-option" data-value=""><span class="option-text">Select a column</span></div>';
                
                columns.forEach(column => {
                    // Add to hidden select
                    const option = document.createElement('option');
                    option.value = column.name;
                    option.textContent = `${column.name} (${column.type || 'unknown'})`;
                    columnSelect.appendChild(option);
                    
                    // Add to custom dropdown with styled type tag
                    const customOption = document.createElement('div');
                    customOption.className = 'custom-select-option';
                    customOption.dataset.value = column.name;
                    
                    const optionContent = document.createElement('div');
                    optionContent.className = 'option-content';
                    
                    const optionText = document.createElement('span');
                    optionText.className = 'option-text';
                    optionText.textContent = column.name;
                    
                    const typeTag = document.createElement('span');
                    typeTag.className = 'option-type-tag';
                    const shortType = getShortType(column.type);
                    typeTag.textContent = shortType;
                    typeTag.style.backgroundColor = getTagColor(column.type);
                    
                    optionContent.appendChild(optionText);
                    optionContent.appendChild(typeTag);
                    customOption.appendChild(optionContent);
                    columnSelectOptions.appendChild(customOption);
                });
                
                // Reset display
                const resetContent = document.createElement('div');
                resetContent.className = 'option-content';
                const resetText = document.createElement('span');
                resetText.className = 'option-text';
                resetText.textContent = 'Select a column';
                resetContent.appendChild(resetText);
                columnSelectValue.innerHTML = '';
                columnSelectValue.appendChild(resetContent);
                columnSelectWrapper.classList.remove('disabled');
                columnSelect.disabled = false;
            }

            fetch('/api/models')
                .then(response => response.json())
                .then(treeData => {
                    modelTreeContainer.innerHTML = '';
                    allTreeData = treeData;
                    if (treeData && treeData.length > 0) {
                        renderTree(treeData, modelTreeContainer);
                    } else {
                        modelTreeContainer.innerHTML = '<p>No models found.</p>';
                    }
                })
                .catch(error => {
                    console.error("Error fetching model tree:", error);
                    modelTreeContainer.innerHTML = '<p>Error loading models.</p>';
                });
                
            // Custom dropdown functionality
            const columnSelectWrapper = document.getElementById('columnSelectWrapper');
            const columnSelectTrigger = document.getElementById('columnSelectTrigger');
            const columnSelectOptions = document.getElementById('columnSelectOptions');
            const columnSelectValue = columnSelectTrigger.querySelector('.custom-select-value');
            
            // Toggle dropdown
            columnSelectTrigger.addEventListener('click', function(e) {
                if (columnSelectWrapper.classList.contains('disabled')) return;
                e.stopPropagation();
                columnSelectWrapper.classList.toggle('open');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!columnSelectWrapper.contains(e.target)) {
                    columnSelectWrapper.classList.remove('open');
                }
            });
            
            // Handle option selection
            columnSelectOptions.addEventListener('click', function(e) {
                const option = e.target.closest('.custom-select-option');
                if (!option) return;
                
                const value = option.dataset.value;
                const optionContent = option.querySelector('.option-content');
                
                // Update custom dropdown - clone the option content
                columnSelectValue.innerHTML = '';
                if (optionContent) {
                    columnSelectValue.appendChild(optionContent.cloneNode(true));
                } else {
                    const text = option.textContent;
                    columnSelectValue.textContent = text;
                }
                columnSelectOptions.querySelectorAll('.custom-select-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
                columnSelectWrapper.classList.remove('open');
                
                // Update hidden select
                columnSelect.value = value;
                columnSelect.dispatchEvent(new Event('change'));
            });
            
            // Sync with hidden select for compatibility
            columnSelect.addEventListener('change', function() {
                loadLineageBtn.disabled = !this.value || !selectedModelData;
            });
            
            loadLineageBtn.addEventListener('click', function() {
                const column = columnSelect.value;
                if (selectedModelData && selectedModelData.model_name && column) { 
                    fetch(`/api/lineage/${selectedModelData.model_name}/${column}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                console.error(data.error);
                                graphContainer.innerHTML = `<p class="error-message">Error loading lineage: ${data.error}</p>`;
                                return;
                            }
                            graphContainer.innerHTML = '';
                            graphInstance = initGraph(data);
                        })
                        .catch(error => { 
                            console.error("Fetch error:", error);
                            graphContainer.innerHTML = `<p class="error-message">Failed to fetch lineage data.</p>`;
                         });
                }
            });

            // Add event listener for the search input
            searchInput.addEventListener('input', (e) => {
                filterTree(e.target.value);
            });
            {% endif %}
        });
    </script>
</body>
</html>